# Feature 整合討論文件

**會議日期**: 2025-11-30
**準備者**: ZhuMon
**目的**: 討論並解決 6 個 features 之間的整合問題

---

## 📋 會議議程

1. **確認整體架構** (5分鐘) - 檢視依賴關係是否合理
2. **討論 3 個待釐清問題** (30分鐘) - 需要做出決策
3. **確認實作順序** (10分鐘) - 排定開發優先順序
4. **分配後續行動** (5分鐘) - 決定誰更新哪些文件

---

## 1️⃣ 整體架構檢視 (背景說明)

### ✅ 好消息

- **沒有循環依賴** - 所有 features 可以按順序實作
- **大部分整合點已定義清楚** - 90% 的跨 feature 互動都有文件記錄
- **可以開始實作** - 沒有阻擋性問題

### 依賴關係圖

```
Level 1 (基礎層):
└─ Feature 002: 地圖 + 認證

Level 2 (核心服務 - 可平行開發):
├─ Feature 003: 需求管理
├─ Feature 005: 物資管理
└─ Feature 007: 資訊發布

Level 3 (整合服務):
└─ Feature 004: 志工調度 (依賴 002 + 003)

Level 4 (管理層):
└─ Feature 006: 後台管理 (依賴所有 features)
```

**問題**: 大家同意這個依賴順序嗎？

---

## 2️⃣ 需要討論的問題 (重點)

### 問題 A: 權限系統設計方向 ✅ (已解決)

**影響**: 所有 features
**優先級**: 🟢 已解決 - 採用權限優先於角色的設計

#### 決議方案

**採用「權限系統設計」approach**:

1. **定義所有可能的權限** (已完成)

   - 70+ 個細粒度權限，涵蓋所有 6 個 features
   - 權限代碼格式：`feature:action` (如 `request:delete`, `volunteer:verify`)

2. **提供預設角色範本** (已完成)

   - 8 個預設角色：一般民眾、註冊志工、現場協調員、物資管理員、內容管理員、系統管理員、稽核員、超級管理員
   - 每個角色都是權限的組合，可調整

3. **部署組織自行決定**
   - 組織可以直接使用預設角色
   - 組織可以根據需求自訂角色
   - 組織可以決定「誰可以審核志工」等政策問題

#### 原本問題 (志工審核權限) 的解決方式

**權限**: `volunteer:verify` (審核志工申請)

**部署選項**:

- **選項 A**: 給予「現場協調員」角色 → 協調員可以審核
- **選項 B**: 只給「系統管理員」角色 → 只有管理員可以審核
- **選項 C**: 兩者都有此權限 → 彈性最大
- **選項 D**: 創建自訂角色「志工審核員」→ 專門角色

**文件參考**: `docs/rbac-permissions-design.md`

#### 不需再討論

此問題已經通過「權限優先於角色」的設計解決：

- ✅ 所有權限已定義清楚
- ✅ 預設角色範本已提供
- ✅ 部署組織有完全的配置彈性
- ✅ FAQ 已說明「志工審核應該由誰負責」的選擇考量

**後續行動**: 只需在 Feature 004 和 006 規格中加入「參考 rbac-permissions-design.md」即可

---

### 問題 B: 地圖 Marker 擴充性沒有文件 ⚠️

**影響**: Feature 002 (地圖), 003 (需求), 004 (志工), 007 (資訊)
**優先級**: 🟡 中 - 影響 API 設計

#### 現況

多個 features 說它們會在地圖上顯示 markers：

- **Feature 003**: 顯示需求 markers (緊急=紅色, 一般=黃色)
- **Feature 004**: 顯示志工位置 markers (即時追蹤)
- **Feature 007**: 顯示時間軸事件 markers

但 **Feature 002** 的規格只提到：

- Resource Locations (服務中心、避難所)
- 道路狀況 markers
- 受災區域 (多邊形)

#### 需要決定

**選項 1**: Feature 002 提供「通用 marker API」

- 其他 features 自行實作 marker 類型
- Feature 002 負責顯示，不管 marker 內容
- 優點: 最大彈性
- 缺點: 需要定義清楚的 API contract

**選項 2**: Feature 002 明確列出所有 marker 類型

- Feature 002 規格列出：需求 markers, 志工 markers, 時間軸 markers
- 優點: 清楚明確
- 缺點: Feature 002 需要知道所有其他 features

**選項 3**: 混合模式

- Feature 002 定義核心 marker 類型
- 提供「自定義 marker」擴充點
- 優點: 平衡清晰度和彈性
- 缺點: 需要良好文件說明

#### 建議行動

1. 決定採用哪個選項
2. 在 Feature 002 加入「Map Extensibility」章節
3. 創建 `docs/api-contracts.md` 記錄 GeoJSON 格式

**討論問題**:

- Q1: 未來是否會有更多 marker 類型？(如：捐贈點、醫療站)
- Q2: Marker 樣式誰決定？(Feature 002 統一管理 vs 各 feature 自訂)
- Q3: 如何處理 marker 重疊問題？

---

### 問題 C: 志工資料誰擁有？ ⚠️

**影響**: Feature 003 (需求管理), Feature 004 (志工調度)
**優先級**: 🟡 中 - 影響資料庫設計

#### 現況

- **Feature 003** 有大量志工分配功能：

  - 計算志工到任務地點的距離
  - 根據技能建議志工
  - 分配志工到需求
  - 防止重複分配

- **Feature 004** 是志工資料的權威來源 (完整的 Volunteer entity)

#### 需要決定

**選項 1**: Feature 003 呼叫 Feature 004 API

- Feature 003 不儲存志工資料
- 需要建議志工時，即時呼叫 Feature 004
- 優點: 資料一致性最高
- 缺點: 網路延遲，API 相依性高

**選項 2**: Feature 003 有志工資料快取

- Feature 004 更新時同步到 Feature 003
- Feature 003 用快取資料做建議
- 優點: 效能好
- 缺點: 資料同步複雜度

**選項 3**: 共用資料庫

- Features 003 和 004 共用 volunteer 資料表
- 優點: 簡單直接
- 缺點: 違反 feature 獨立性原則

#### 建議行動

1. 決定採用哪個選項
2. 更新 Feature 003 的「Integration Points」章節
3. 記錄 API contract (如果選選項 1 或 2)

**討論問題**:

- Q1: 志工建議需要多即時？(可接受 5 秒延遲嗎？)
- Q2: 系統架構偏好？(微服務 vs 單體式)
- Q3: 志工資料更新頻率？(每秒 vs 每分鐘)

---

## 3️⃣ 實作順序建議

### 建議的 Sprint 規劃

```
Sprint 1-2 (4週):  Feature 002 - 地圖基礎
  ✓ 核心地圖功能
  ✓ LINE 2FA 認證
  ✓ Resource Location 模型
  ✓ 決定 marker API 設計 (問題 B)

Sprint 3-5 (6週):  平行開發
  ✓ Feature 003 - 需求管理 (團隊 A)
  ✓ Feature 005 - 物資管理 (團隊 B)
  ✓ Feature 007 - 資訊發布 (團隊 C)
  ⚠️ 需要解決問題 B 和 C 才能開始

Sprint 6-7 (4週):  Feature 004 - 志工調度
  ✓ 依賴 002 + 003 完成
  ⚠️ 需要解決問題 A 才能開始

Sprint 8-9 (4週):  Feature 006 - 後台管理
  ✓ 整合所有 features
  ✓ RBAC 和稽核記錄
```

**討論問題**:

- Q1: 這個時程可行嗎？
- Q2: 有足夠的開發團隊嗎？
- Q3: 是否需要調整優先順序？

---

## 4️⃣ 需要的後續行動

### 立即行動 (會議決議後)

- [x] **權限系統設計**: 定義所有權限和預設角色 → _完成_ (見 `docs/rbac-permissions-design.md`)
- [ ] **決策紀錄**: 記錄問題 B, C 的決定 → _指派給:_ \***\*\_\_\_\*\***
- [ ] **更新 Feature 004 規格**: 加入權限系統參考 → _指派給:_ \***\*\_\_\_\*\***
- [ ] **更新 Feature 006 規格**: 加入權限系統參考 → _指派給:_ \***\*\_\_\_\*\***
- [ ] **更新 Feature 002 規格**: 加入 marker 擴充說明 → _指派給:_ \***\*\_\_\_\*\***
- [ ] **更新 Feature 003 規格**: 釐清志工資料整合 → _指派給:_ \***\*\_\_\_\*\***

### 短期行動 (1週內)

- [ ] **創建 API contracts 文件**: `docs/api-contracts.md` → _指派給:_ \***\*\_\_\_\*\***
- [ ] **建立角色權限矩陣**: 誰可以做什麼 → _指派給:_ \***\*\_\_\_\*\***
- [ ] **整合測試場景文件**: 跨 feature 測試 → _指派給:_ \***\*\_\_\_\*\***

### 中期行動 (Sprint 1 開始前)

- [ ] **技術架構設計**: 基於今天的決策 → _指派給:_ \***\*\_\_\_\*\***
- [ ] **資料庫 Schema 設計**: 確認各 feature 資料模型 → _指派給:_ \***\*\_\_\_\*\***
- [ ] **開發環境設置**: 團隊協作工具 → _指派給:_ \***\*\_\_\_\*\***

---

## 5️⃣ 補充資料

### 已驗證的一致性 ✅ (不需討論)

以下整合點已經確認沒問題：

- ✅ Feature 005 → Feature 003: 物資需求連結 (使用 category=supplies)
- ✅ Feature 004 → Feature 003: 志工更新需求狀態 (狀態流程一致)
- ✅ Feature 006 → 所有 features: 管理員權限 (各 feature 都支援)
- ✅ Feature 005 → Feature 002: 倉庫位置 (正確使用 Resource Locations)
- ✅ 所有 features: 認證機制 (都基於 Feature 002 的 LINE 2FA)

### 風險評估

- **技術風險**: 🟢 低 - 沒有技術上不可行的需求
- **整合風險**: 🟡 中 - 需要良好的 API 設計和測試
- **時程風險**: 🟡 中 - 依賴問題解決速度
- **人力風險**: ❓ 未知 - 取決於團隊大小

### 參考文件

- 完整分析報告: `claudedocs/feature-dependency-analysis.md`
- Feature 規格: `specs/00X-feature-name/spec.md`
- 依賴關係圖: 見本文件 Section 1

---

## 6️⃣ 討論紀錄 (會議中填寫)

### 問題 A: 權限系統設計 ✅

**決定**: 採用「權限優先於角色」設計，定義 70+ 個細粒度權限，提供 8 個預設角色範本，由部署組織自行決定角色配置

**理由**:

- 提供最大彈性，不同組織有不同需求
- 避免在規格階段做出限制性決定
- 讓實際使用者（部署組織）有控制權
- 預設角色可以直接使用或作為起點自訂

**行動**:

- ✅ 已完成權限系統設計文件 (`docs/rbac-permissions-design.md`)
- ⏳ 待更新 Feature 004 和 006 規格，加入文件參考
- ⏳ 部署時由組織決定實際角色配置

---

### 問題 B: 地圖 Marker 擴充決議

**決定**: ********\*\*\*\*********\_\_\_\_********\*\*\*\*********

**理由**: ********\*\*\*\*********\_\_\_\_********\*\*\*\*********

**行動**: ********\*\*\*\*********\_\_\_\_********\*\*\*\*********

---

### 問題 C: 志工資料擁有權決議

**決定**: ********\*\*\*\*********\_\_\_\_********\*\*\*\*********

**理由**: ********\*\*\*\*********\_\_\_\_********\*\*\*\*********

**行動**: ********\*\*\*\*********\_\_\_\_********\*\*\*\*********

---

### 實作順序調整 (如有)

**調整**: ********\*\*\*\*********\_\_\_\_********\*\*\*\*********

**理由**: ********\*\*\*\*********\_\_\_\_********\*\*\*\*********

---

### 其他討論事項

---

---

---

---

### 下次會議

**日期**: ********\*\*\*\*********\_\_\_\_********\*\*\*\*********

**議程**:

1. 檢視規格更新進度
2. 確認 API contracts 文件
3. 討論技術架構設計

---

## 附件: 快速決策表格

### 問題 A 決策輔助

| 選項              | 優點         | 缺點           | 適用情境            |
| ----------------- | ------------ | -------------- | ------------------- |
| Coordinators 審核 | 分散工作量   | 需要訓練       | 志工數量大 (>100人) |
| 只有 Admins 審核  | 品質控管嚴格 | Admin 工作量大 | 志工數量小 (<50人)  |
| 兩者都可以        | 最大彈性     | 系統複雜       | 有階段性審核需求    |

### 問題 B 決策輔助

| 選項             | 技術複雜度 | 維護成本 | 擴充性     |
| ---------------- | ---------- | -------- | ---------- |
| 通用 marker API  | 🟡 中      | 🟢 低    | ⭐⭐⭐⭐⭐ |
| 明確列出所有類型 | 🟢 低      | 🔴 高    | ⭐⭐       |
| 混合模式         | 🟡 中      | 🟡 中    | ⭐⭐⭐⭐   |

### 問題 C 決策輔助

| 選項         | 效能       | 資料一致性 | 實作複雜度             |
| ------------ | ---------- | ---------- | ---------------------- |
| API 即時呼叫 | 🟡 中      | ⭐⭐⭐⭐⭐ | 🟢 低                  |
| 資料快取     | ⭐⭐⭐⭐⭐ | ⭐⭐⭐     | 🟡 中                  |
| 共用資料庫   | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 🟢 低 (但違反設計原則) |

---

**準備者備註**:

- 這份文件包含所有必要的背景資訊和決策選項
- 請在會議前閱讀 Section 1-2 (大約 10 分鐘)
- 會議重點是 Section 2 的三個問題
- 完整技術細節請參考 `claudedocs/feature-dependency-analysis.md`
